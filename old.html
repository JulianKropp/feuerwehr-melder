<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Feuerwehr Rauenthal – Alarmoberfläche</title>
<style>
:root{
  --bg:#f4f4f4; --card:#fff; --brand:#d32f2f; --sidebar:#1f2937; --sidebar-hover:#374151; --text:#0f172a;
  --status-1:#16a34a; --status-2:#0284c7; --status-3:#f59e0b; --status-4: #ff4444; --status-6:#6b7280;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:Inter,Arial,sans-serif;font-size:18px;background:var(--bg);color:var(--text);display:flex}
.sidebar{width:260px;background:var(--sidebar);color:#fff;padding:20px;display:flex;flex-direction:column;gap:12px}
.brand{font-weight:800;font-size:26px;text-align:center;line-height:1.1}
.nav a{display:block;color:#fff;text-decoration:none;padding:12px;border-radius:8px;margin:4px 0;font-weight:600}
.nav a:hover{background:var(--sidebar-hover)}
.nav a.active{background:#0b1220}
.main{flex:1;padding:20px;overflow:auto}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.08);margin-bottom:16px}
h1{font-size:26px;margin-bottom:10px}
h2{font-size:22px;margin-bottom:8px}
.btn{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
.btn.small{padding:6px 10px;font-size:14px}
.btn.ghost{background:transparent;border:1px solid #ccc;color:var(--text)}
input,select,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:16px;width:100%;margin-bottom:10px}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff;border:1px solid #eee;margin-bottom:6px}
.status-select{padding:6px 10px;border-radius:6px;border:none;color:#fff;font-weight:600}
.status-1{background:var(--status-1)}
.status-2{background:var(--status-2)}
.status-3{background:var(--status-3);color:#000}
.status-4{background:var(--status-4)}
.status-6{background:var(--status-6)}
.dot{width:50px;height:50px;border-radius:50%;display:inline-block;margin-right:6px;background:#d1d5db}
.dot.red{background:#ef4444}
.small-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 6px;
  background: #d1d5db;
}

.small-dot.red {
  background: #ef4444;
}
.blink{animation:blink 1s infinite}
@keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0.3}}
.monitor{background:#071225;color:#fff;min-height:100vh}
.monitor .card {background: transparent; color: #fff; box-shadow: none; border: none;}
.big{font-size:76px;font-weight:900;line-height:1}
.page.monitor {
  padding: 0;
  margin: 0;
  width: 100vw;
  height: 100vh;
  position: relative; /* WICHTIG für absolute Position der Popups */
}
body.monitor-active {background: #071225;}
body.monitor-active .main {padding: 0 !important;}
.main {padding: 0 !important; margin: 0 !important; flex: 1;}
.monitor-sub{font-size:42px;margin-top:12px}
.clock{font-size:32px;font-weight:700;text-align:right}
.voralarm{font-size:128px;font-weight:900;color:#ff4444;letter-spacing:2px;animation:blink 1s infinite}
.map{width:100%;height:320px;border:0;border-radius:8px;margin-top:12px}
.monitor-list div{margin-bottom:12px;font-size:30px;padding:20px;border-radius:6px;background:#071a2b}
.form-vehicles{max-height:220px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;background:#fff}
.small-muted{color:#6b7280;font-size:14px;margin-top:6px}
.monitor-notice-popup {
  position: absolute; /* innerhalb Monitor */
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  color: #000;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  font-size: 24px;
  text-align: center;
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 9999;
}
.monitor-notice-popup.show {
  opacity: 1;
}
.popup {
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.popup-content {
  background:#fff;
  padding:20px;
  border-radius:12px;
  min-width:300px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.input {
  width:100%;
  padding:6px;
  border:1px solid #ccc;
  border-radius:6px;
}
#plannedVehicles .vehicle-item {
  display: flex;
  align-items: center;   /* vertikal mittig */
  margin-bottom: 6px;
  gap: 8px;              /* Abstand Checkbox ↔ Fahrzeugname */
}

#plannedVehicles .vehicle-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
  flex-shrink: 0;
#formVehicles .vehicle-item {
  margin-bottom: 6px;
}

#formVehicles .vehicle-label {
  display: flex;
  align-items: center; /* vertikal mittig */
  gap: 8px;            /* Abstand Checkbox ↔ Text */
}

#formVehicles .vehicle-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  margin: 0;
}
</style>
</head>
<body>
<aside class="sidebar" id="sidebar">
  <div class="brand">Feuerwehr<br/>Rauenthal</div>
  <nav class="nav">
    <a href="#" data-page="dashboard" class="active">Dashboard</a>
    <a href="#" data-page="incidents">Einsätze</a>
    <a href="#" data-page="notice">Mitteilung</a>	
    <a href="#" data-page="vehicles">Fahrzeuge</a>
	<a href="#" data-page="planned">Geplante Einsätze</a>
	<a href="#" data-page="organisation">Mitglieder verwalten</a>	
    <a href="#" data-page="monitor">Monitor</a>
	<a href="#" data-page="settings">Einstellungen</a>
  </nav>
</aside>

<main class="main">
  <!-- Dashboard -->
  <section id="page-dashboard" class="page">
    <h1>Dashboard</h1>
    <div class="card">
      <h2>Aktiver Einsatz</h2>
      <div id="activeIncidentBox" class="small-muted">– Kein Einsatz aktiv –</div>
    </div>
    <div class="card">
      <h2>Fahrzeuge</h2>
      <div id="dashVehicles"></div>
    </div>
	 <div class="card" style="margin-top:20px;">
    <h2>Nächste Ereignisse</h2>
    <div id="dashboardEvents" style="display:flex; flex-direction:column; gap:12px;"></div>
  </div>
  </section>

  <!-- Einsätze -->
  <section id="page-incidents" class="page" style="display:none">
    <h1>Einsätze</h1>
    <div style="margin-bottom:12px">
      <button class="btn small" onclick="openIncidentForm()">Einsatz erstellen</button>
      <button class="btn small ghost" onclick="triggerVoralarm()">Voralarm</button>
    </div>
    <div id="incidentList"></div>
  </section>

  <!-- Einsatz erstellen -->
  <section id="page-create" class="page" style="display:none">
    <h1>Einsatz erstellen</h1>
    <div class="card">
      <label for="formKeyword">Stichwort</label>
      <input id="formKeyword" type="text" placeholder="z. B. F1B"/>
	  <label for="formDesc">Beschreibung</label>
      <textarea id="formDesc" rows="4" placeholder="Kurzbeschreibung..."></textarea>
      <label for="formAddress">Adresse</label>
      <input id="formAddress" type="text" placeholder="Straße, Ort"/>
      <label>Fahrzeuge auswählen</label>
	<div id="formVehicles" class="form-vehicles"></div>


</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="saveIncident('draft')">Speichern (Entwurf)</button>
        <button class="btn" onclick="saveIncident('active')">Alarmieren</button>
        <button class="btn ghost" onclick="triggerVoralarm()">Voralarm</button>
      </div>
    </div>
  </section>
  
  <!-- Geplante Einsätze -->
<section id="page-planned" class="page" style="display:none">
  <h1>Geplante Einsätze</h1>
  <div style="margin-bottom:12px">
    <button class="btn small" onclick="openPlannedForm()">Geplanten Einsatz erstellen</button>
  </div>
  <div id="plannedList"></div>
</section>

<!-- Kalender -->
<section id="page-calendar" class="page" style="display:none">
  <h1>Kalender</h1>
  <button class="btn small" onclick="openEventPopup()">Neuen Termin hinzufügen</button>
  
  <div id="calendarList" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
  
  <div style="margin-top:20px;">
    <button class="btn small ghost" onclick="toggleExpiredEvents()">Abgelaufene Termine anzeigen</button>
    <div id="expiredList" style="margin-top:12px; display:none; flex-direction:column; gap:12px;"></div>
  </div>
</section>

<!-- Popup für Termin -->
<div id="eventPopup" class="popup" style="display:none;">
  <div class="popup-content">
    <h2 id="eventPopupTitle">Neuer Termin</h2>
    <label>Titel:</label>
    <input type="text" id="eventTitle" class="input" placeholder="z.B. Versammlung"><br><br>
    <label>Datum & Uhrzeit:</label>
    <input type="datetime-local" id="eventDatetime" class="input"><br><br>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button class="btn small ghost" onclick="closeEventPopup()">Abbrechen</button>
      <button class="btn small" onclick="saveEventPopup()">Speichern</button>
    </div>
  </div>
</div>

<!-- Formular für geplanten Einsatz (Overlay) -->
<div id="plannedFormOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
    background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:9999;">
  <div style="background:#fff; padding:20px; border-radius:12px; max-height:90vh; overflow:auto; min-width:320px;">
    <h2>Geplanten Einsatz erstellen</h2>
    <label for="plannedKeyword">Stichwort</label>
    <input id="plannedKeyword" type="text" placeholder="z. B. F1B"/>
    <label for="plannedDesc">Beschreibung</label>
    <textarea id="plannedDesc" rows="4" placeholder="Kurzbeschreibung..."></textarea>
    <label for="plannedAddress">Adresse</label>
    <input id="plannedAddress" type="text" placeholder="Straße, Ort"/>
    <label>Datum</label>
    <input id="plannedDate" type="date"/>
    <label>Uhrzeit</label>
    <input id="plannedTime" type="time"/>
    <label>Fahrzeuge auswählen</label>
<div id="plannedVehicles" class="form-vehicles">
  <div class="vehicle-item">
    <label class="vehicle-label">
      <input type="checkbox" value="fahrzeug1" onchange="togglePlannedVehicle('fahrzeug1', this.checked)">
    </label>
  </div>
  <div class="vehicle-item">
    <label class="vehicle-label">
      <input type="checkbox" value="fahrzeug2" onchange="togglePlannedVehicle('fahrzeug2', this.checked)">
    </label>
  </div>
  <!-- weitere Fahrzeuge hier nach dem gleichen Muster -->
</div>

    <div style="margin-top:8px; display:flex; gap:8px;">
      <button class="btn" onclick="savePlannedIncident()">Speichern</button>
      <button class="btn ghost" onclick="closePlannedForm()">Abbrechen</button>
    </div>
  </div>
</div>

  <!-- Einsatzdetails -->
  <section id="page-incident-detail" class="page" style="display:none">
    <h1>Einsatzdetails</h1>
    <div class="card">
      <div id="detailKeyword"></div>
      <div id="detailAddress"></div>
      <div id="detailDesc"></div>
      <div id="detailStatus"></div>
      <iframe id="detailMap" class="map" loading="lazy"></iframe>
      <div style="margin-top:10px">
        <button class="btn small" onclick="nachalarmieren()">Nachalarmieren</button>
        <button class="btn small ghost" onclick="endIncident()">Einsatz beenden</button>
      </div>
    </div>
  </section>

  <!-- Fahrzeuge -->
  <section id="page-vehicles" class="page" style="display:none">
    <h1>Fahrzeuge</h1>
    <div style="margin-bottom:12px"><button class="btn small" onclick="addVehicle()">Fahrzeug hinzufügen</button></div>
    <div id="vehicleList"></div>
  </section>
  
<!-- Organisation -->
<section id="page-organisation" class="page" style="display:none">
  <h1>Mitglieder verwalten</h1>
  <div class="card">
    <h2>Mitglieder</h2>
<div style="margin-bottom:12px;">
  <label for="memberFilter">Filter:</label>
  <select id="memberFilter" onchange="renderOrganisationPage()">
    <option value="all">Alle</option>
    <!-- Fahrzeugoptionen werden per JS hinzugefügt -->
  </select>
</div>
    <div id="memberList"></div>
    <div style="margin-top:8px">
      <button class="btn small" onclick="addMember()">Mitglied hinzufügen</button>
    </div>
  </div>
</section>


 <!-- Einstellungen -->
<section id="page-settings" class="page" style="display:none">
  <h1>Einstellungen</h1>
  
  <div class="card">
    <label>Gong</label>
    <select id="gong">
      <option value="gong1">Gong 1</option>
      <option value="gong2">Gong 2</option>
      <option value="gong3">Gong 3</option>
    </select>
    <div style="margin-top:8px">
      <button class="btn small" onclick="testGong()">Gong testen</button>
    </div>
  </div>
  
  <div class="card" style="margin-top:12px">
    <h2>Zurücksetzen</h2>
    <p>Alle Daten löschen und Demo-Daten neu laden.</p>
    <button class="btn" onclick="resetAll()">Alles zurücksetzen</button>
  </div>
</section>

  <!-- Monitor -->
<section id="page-monitor" class="page monitor" style="display:none">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; width:100%;">
    <!-- Uhr links -->
    <div class="clock" id="clock" style="flex:0;"></div>

    <!-- Schriftzug zentriert -->
    <div id="monitorHeader" style="flex:1; text-align:center; color:#ff4444; font-size:36px; font-weight:900;">
      Jugendfeuerwehr Rauenthal
    </div>

    <!-- Audio-Button rechts -->
    <div id="audioBtnContainer" style="flex:0;">
      <button id="audioBtn" class="btn small" onclick="monitorEnableAudio()">Audio aktivieren</button>
    </div>
  </div>

    <div class="card" id="monitorIncident">– Kein Einsatz aktiv –</div>

    <div class="card">
      <h2>Fahrzeuge</h2>
      <div id="monitorVehicles" class="monitor-list"></div>
    </div>

    <div class="card" id="monitorNoticeCard">
      <h2>Letzte Einsätze</h2>
      <div id="monitorNotice"></div>
    </div>

    <div class="card">
      <h2>Wetter</h2>
      <div id="weatherBox" style="font-size:28px;font-weight:700">–</div>
    </div>
  </section>

  <!-- Mitteilung -->
  <section id="page-notice" class="page" style="display:none">
    <h1>Mitteilung</h1>
    <div class="card">
      <textarea id="noticeText" rows="4" placeholder="Mitteilungstext..."></textarea>
      <div style="margin-top:10px"><button class="btn" onclick="sendNotice()">Senden & Vorlesen</button></div>
    </div>
  </section>
</main>

<audio id="gongAudio" preload="auto"></audio>

<script>
// -------------------- JS --------------------
// State
const STORAGE_KEYS = { VEHICLES:'vehicles', INCIDENTS:'incidents', ACTIVE:'activeIncident', VOR:'voralarm', NOTICE:'notice', AUDIO_ACT:'audioActivated' };
const gongs = { gong1:'gong1.mp3', gong2:'gong2.mp3', gong3:'gong3.mp3' };
function uid(pref='id'){return pref+'_'+Date.now()+'_'+Math.floor(Math.random()*900+100);}
let vehicles = JSON.parse(localStorage.getItem(STORAGE_KEYS.VEHICLES)||'{}');
let incidents = JSON.parse(localStorage.getItem(STORAGE_KEYS.INCIDENTS)||'{}');
let activeId = localStorage.getItem(STORAGE_KEYS.ACTIVE)||null;
let voralarmActive = localStorage.getItem(STORAGE_KEYS.VOR) === 'true';
let noticeText = localStorage.getItem(STORAGE_KEYS.NOTICE) || '';
let detailId = null;
let audioEnabled = localStorage.getItem(STORAGE_KEYS.AUDIO_ACT)==='true';
let selectedVehicles = [];

function resetAll(){
  if(!confirm('Alle Daten löschen und auf Demo zurücksetzen?')) return;

  // Local Storage leeren
  localStorage.clear();

  // Variablen zurücksetzen
  vehicles = {};
  incidents = {};
  activeId = null;
  voralarmActive = false;
  noticeText = '';
  selectedVehicles = [];
  detailId = null;
  audioEnabled = false;

  // Demo-Daten neu laden
  ensureDemoData();
  renderAllPages();
  alert('Alle Daten wurden zurückgesetzt.');
}

function openIncidentForm() {
  document.getElementById('page-create').style.display = '';
  renderFormVehicles(); // ✅ Checkboxen generieren
}

function renderFormVehicles() {
  const container = document.getElementById('formVehicles');
  if (!container) return;

  container.innerHTML = ''; // alles leeren

  Object.values(vehicles).forEach(v => {
    const checked = selectedIncidentVehicles.includes(v.id) ? 'checked' : '';

    const div = document.createElement('div');
    div.className = 'vehicle-item';

    const label = document.createElement('label');
    label.className = 'vehicle-label';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.value = v.id;
    checkbox.checked = selectedIncidentVehicles.includes(v.id);
    checkbox.onchange = (e) => toggleIncidentVehicle(v.id, e.target.checked);

    const span = document.createElement('span');
    span.className = 'vehicle-text';
    span.innerHTML = `<b>${escapeHtml(v.name)}</b> (${escapeHtml(v.call)})`;

    label.appendChild(checkbox);
    label.appendChild(span);
    div.appendChild(label);
    container.appendChild(div);
  });
}

function renderOrganisationPage() {
  const ml = document.getElementById('memberList');
  const filterSelect = document.getElementById('memberFilter');
  if (!ml || !filterSelect) return;

  const filter = filterSelect.value; // aktuell ausgewählter Filter
  ml.innerHTML = '';

  Object.values(members).forEach(m => {
    // Nur anzeigen, wenn Filter passt
    if (filter !== 'all' && (!m.vehicles || !m.vehicles.includes(filter))) return;

    const vehicleNames = (m.vehicles || []).map(id => vehicles[id]?.name).filter(Boolean).join(', ') || '–';
    ml.innerHTML += `<div class="list-item">
      <div><b>${escapeHtml(m.name)}</b> (${escapeHtml(m.role)}) — Fahrzeuge: ${escapeHtml(vehicleNames)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small" onclick="editMember('${m.id}')">Bearbeiten</button>
        <button class="btn small ghost" onclick="deleteMember('${m.id}')">Löschen</button>
      </div>
    </div>`;
  });
}

function populateVehicleFilter() {
  const filterSelect = document.getElementById('memberFilter');
  if (!filterSelect) return;

  // Vorhandene Fahrzeugoptionen entfernen (außer "Alle")
  filterSelect.querySelectorAll('option:not([value="all"])').forEach(o => o.remove());

  Object.values(vehicles).forEach(v => {
    const option = document.createElement('option');
    option.value = v.id;
    option.textContent = v.name;
    filterSelect.appendChild(option);
  });
}

// Einmal beim Laden aufrufen
window.addEventListener('DOMContentLoaded', () => {
  populateVehicleFilter();
  renderOrganisationPage();
});

// Sicherstellen, dass Overlay beim Start versteckt ist
window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('plannedFormOverlay').style.display = 'none';
});

// Automatische Aktualisierung bei Änderungen in localStorage
window.addEventListener('storage', (event) => {
  if (event.key === 'plannedIncidents' || event.key === 'calendarEvents') {
    plannedIncidents = JSON.parse(localStorage.getItem('plannedIncidents') || '{}');
    calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '{}');
    renderDashboardEvents(); // bestehende Funktion aufrufen
  }
});

// Nach Definition von renderPlannedList
window.addEventListener('DOMContentLoaded', () => {
    renderPlannedList(); // geplante Einsätze direkt beim Laden anzeigen
    document.getElementById('plannedFormOverlay').style.display = 'none'; // Overlay verstecken
});

function addIncident(incident) {
  plannedIncidents[incident.id] = incident; // statt push()
  localStorage.setItem('plannedIncidents', JSON.stringify(plannedIncidents));
  renderDashboardEvents();
}

function renderDashboardEvents(){
  const container = document.getElementById('dashboardEvents');
  if(!container) return;
  container.innerHTML='';

  const allItems = [
    ...Object.values(plannedIncidents).map(i=>({...i, type:'planned', title:i.keyword})),
    ...Object.values(calendarEvents).map(t=>({...t, type:'event'}))
  ];

  // sortieren
  allItems.sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));

  // nur die nächsten 3 zukünftigen anzeigen
  const now = new Date();
  const upcoming = allItems.filter(i => new Date(i.datetime) >= now).slice(0,3);

  upcoming.forEach(item=>{
    const dt = new Date(item.datetime);
    const dateStr = dt.toLocaleDateString('de-DE', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });
    const timeStr = dt.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });

    const color = item.type==='planned' ? '#ffdddd' : '#dde7ff';

    container.innerHTML += `<div class="card" style="background:${color}">
      <div><b>${escapeHtml(item.title)}</b></div>
      <div>${dateStr} ${timeStr}</div>
      ${item.vehicles && item.vehicles.length ? `<div>Fahrzeuge: ${item.vehicles.map(id=>vehicles[id]?.name).filter(Boolean).join(', ')}</div>` : ''}
    </div>`;
  });
}

const vehiclesLink = document.querySelector('.nav a[data-page="vehicles"]');
vehiclesLink.insertAdjacentHTML('afterend', `<a href="#" data-page="calendar">Kalender</a>`);
document.querySelectorAll('.nav a[data-page="calendar"]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.getElementById('page-calendar').style.display='';
    document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active'));
    a.classList.add('active');
    renderCalendar();
  });
});

let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')||'{}');
let editingEventId = null;

function saveCalendarEvents() {
  localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
  renderCalendar();
  renderDashboardEvents();
}

// Popup öffnen (neu oder bearbeiten)
function openEventPopup(id=null) {
  editingEventId = id;
  const popup = document.getElementById('eventPopup');
  const titleInput = document.getElementById('eventTitle');
  const dateInput = document.getElementById('eventDatetime');
  const h2 = document.getElementById('eventPopupTitle');

  if(id && calendarEvents[id]){
    const e = calendarEvents[id];
    h2.textContent = 'Termin bearbeiten';
    titleInput.value = e.title;
    dateInput.value = e.datetime;
  } else {
    h2.textContent = 'Neuer Termin';
    titleInput.value = '';
    dateInput.value = '';
  }

  popup.style.display = 'flex';
}

function closeEventPopup(){
  document.getElementById('eventPopup').style.display = 'none';
  editingEventId = null;
}

function saveEventPopup(){
  const title = document.getElementById('eventTitle').value.trim();
  const datetime = document.getElementById('eventDatetime').value;
  if(!title || !datetime){ alert("Bitte Titel und Datum angeben"); return; }

  if(editingEventId && calendarEvents[editingEventId]){
    calendarEvents[editingEventId].title = title;
    calendarEvents[editingEventId].datetime = datetime;
  } else {
    const id = uid('cal');
    calendarEvents[id] = {id, title, datetime};
  }

  saveCalendarEvents();
  closeEventPopup();
}

// Termin löschen
function deleteCalendarEvent(id) {
  if(!confirm('Termin löschen?')) return;
  delete calendarEvents[id];
  saveCalendarEvents();
}

// Toggle abgelaufene Termine
function toggleExpiredEvents(){
  const expiredDiv = document.getElementById('expiredList');
  expiredDiv.style.display = expiredDiv.style.display==='none' ? 'flex' : 'none';
}

// Render Kalender
function renderCalendar() {
  const list = document.getElementById('calendarList');
  const expiredList = document.getElementById('expiredList');
  if(!list || !expiredList) return;
  list.innerHTML='';
  expiredList.innerHTML='';
  renderDashboardEvents();

  // Kombinieren
  const allItems = [
    ...Object.values(plannedIncidents).map(i=>({...i, type:'planned', title:i.keyword})),
    ...Object.values(calendarEvents).map(t=>({...t, type:'event'}))
  ];

  // Chronologisch (nächster Termin zuerst)
  allItems.sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));

  const now = new Date();

  allItems.forEach(item => {
    const dt = new Date(item.datetime);
    const dateStr = dt.toLocaleDateString('de-DE', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });
    const timeStr = dt.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });

    let buttons = '';
    if(item.type==='planned'){
      buttons += `<button class="btn small" onclick="editPlannedIncident('${item.id}')">Bearbeiten</button>
                  <button class="btn small" onclick="movePlannedToIncidents('${item.id}')">Zu Einsätzen</button>
                  <button class="btn small ghost" onclick="deletePlannedIncident('${item.id}')">Löschen</button>`;
    } else {
      buttons += `<button class="btn small" onclick="openEventPopup('${item.id}')">Bearbeiten</button>
                  <button class="btn small ghost" onclick="deleteCalendarEvent('${item.id}')">Löschen</button>`;
    }

    const color = item.type==='planned' ? '#ffdddd' : '#dde7ff';

    const card = `<div class="card" style="background:${color}">
      <div><b>${escapeHtml(item.title)}</b></div>
      <div>${dateStr} ${timeStr}</div>
      ${item.vehicles && item.vehicles.length ? `<div>Fahrzeuge: ${item.vehicles.map(id=>vehicles[id]?.name).filter(Boolean).join(', ')}</div>` : ''}
      <div style="margin-top:6px; display:flex; gap:6px;">${buttons}</div>
    </div>`;

    // abgelaufen (>1h)
    if(item.type==='event' && now - dt > 3600000){
      expiredList.innerHTML += card;
    } else {
      list.innerHTML += card;
    }
  });
}

// Geplante Einsätze
let plannedIncidents = JSON.parse(localStorage.getItem('plannedIncidents') || '{}');
let selectedPlannedVehicles = [];

// Formular öffnen
function openPlannedForm(){
  document.getElementById('plannedFormOverlay').style.display = 'flex';
  document.getElementById('plannedKeyword').value='';
  document.getElementById('plannedDesc').value='';
  document.getElementById('plannedAddress').value='';
  document.getElementById('plannedDate').value='';
  document.getElementById('plannedTime').value='';
  selectedPlannedVehicles = [];
  renderPlannedFormVehicles();
}

// Formular schließen
function closePlannedForm(){ document.getElementById('plannedFormOverlay').style.display='none'; }

// Fahrzeuge rendern
function renderPlannedFormVehicles(){
  const fv = document.getElementById('plannedVehicles');
  if(!fv) return;
  fv.innerHTML='';
  Object.values(vehicles).forEach(v=>{
    const checked = selectedPlannedVehicles.includes(v.id) ? 'checked' : '';
    fv.innerHTML += `
      <div class="vehicle-item">
        <input type="checkbox" value="${v.id}" ${checked} onchange="togglePlannedVehicle('${v.id}', this.checked)">
        <div class="vehicle-label">${escapeHtml(v.name)} (${escapeHtml(v.call)})</div>
      </div>
    `;
  });
}


// Fahrzeug auswählen
function togglePlannedVehicle(id, checked){
  if(checked){
    if(!selectedPlannedVehicles.includes(id)) selectedPlannedVehicles.push(id);
  } else {
    selectedPlannedVehicles = selectedPlannedVehicles.filter(x=>x!==id);
  }
}

// Speichern geplanten Einsatz
function savePlannedIncident(){
  const keyword = document.getElementById('plannedKeyword').value.trim();
  if(!keyword){ alert('Bitte Stichwort eingeben'); return; }
  const address = document.getElementById('plannedAddress').value.trim();
  const desc = document.getElementById('plannedDesc').value.trim();
  const date = document.getElementById('plannedDate').value;
  const time = document.getElementById('plannedTime').value;
  if(!date || !time){ alert('Bitte Datum und Uhrzeit eingeben'); return; }
  const id = uid('planned');
  plannedIncidents[id] = {
    id, keyword, address, desc,
    datetime: date+'T'+time,
    vehicles: [...selectedPlannedVehicles]
  };
  localStorage.setItem('plannedIncidents', JSON.stringify(plannedIncidents));
  closePlannedForm();
  renderPlannedList();
}

// Liste geplante Einsätze rendern
function renderPlannedList(){
  const list = document.getElementById('plannedList');
  if(!list) return;
  list.innerHTML='';
  Object.values(plannedIncidents)
    .sort((a,b)=>a.datetime.localeCompare(b.datetime))
    .forEach(p=>{
      list.innerHTML += `<div class="list-item">
        <div>
          <b>${escapeHtml(p.keyword)}</b> — ${escapeHtml(p.address)}<br/>
          ${new Date(p.datetime).toLocaleString()} — Fahrzeuge: ${(p.vehicles||[]).map(id=>vehicles[id]?.name).filter(Boolean).join(', ') || '–'}
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn small" onclick="editPlannedIncident('${p.id}')">Bearbeiten</button>
          <button class="btn small" onclick="movePlannedToIncidents('${p.id}')">Zu Einsätzen</button>
          <button class="btn small ghost" onclick="deletePlannedIncident('${p.id}')">Löschen</button>
        </div>
      </div>`;
    });
}

// Geplanten Einsatz löschen
function deletePlannedIncident(id){ if(confirm('Geplanten Einsatz löschen?')){ delete plannedIncidents[id]; localStorage.setItem('plannedIncidents', JSON.stringify(plannedIncidents)); renderPlannedList(); } }

// Geplanten Einsatz bearbeiten
function editPlannedIncident(id){
  const p = plannedIncidents[id]; if(!p) return;
  document.getElementById('plannedKeyword').value = p.keyword;
  document.getElementById('plannedDesc').value = p.desc;
  document.getElementById('plannedAddress').value = p.address;
  const dt = new Date(p.datetime);
  document.getElementById('plannedDate').value = dt.toISOString().split('T')[0];
  document.getElementById('plannedTime').value = dt.toTimeString().slice(0,5);
  selectedPlannedVehicles = [...(p.vehicles||[])];
  renderPlannedFormVehicles();
  document.getElementById('plannedFormOverlay').style.display = 'flex';
  // Überschreibe savePlannedIncident temporär
  const origSave = savePlannedIncident;
  savePlannedIncident = ()=>{
    p.keyword = document.getElementById('plannedKeyword').value.trim();
    p.address = document.getElementById('plannedAddress').value.trim();
    p.desc = document.getElementById('plannedDesc').value.trim();
    const date = document.getElementById('plannedDate').value;
    const time = document.getElementById('plannedTime').value;
    if(!p.keyword || !date || !time){ alert('Bitte alle Felder ausfüllen'); return; }
    p.datetime = date+'T'+time;
    p.vehicles = [...selectedPlannedVehicles];
    localStorage.setItem('plannedIncidents', JSON.stringify(plannedIncidents));
    closePlannedForm();
    renderPlannedList();
    savePlannedIncident = origSave; // wiederherstellen
  };
}

// Geplanten Einsatz zu normalen Einsätzen verschieben
function movePlannedToIncidents(id){
  const p = plannedIncidents[id]; if(!p) return;
  const newId = uid('inc');
  incidents[newId] = {
    id: newId,
    keyword: p.keyword,
    address: p.address,
    desc: p.desc,
    vehicles: [...p.vehicles],
    status: 'draft'
  };
  delete plannedIncidents[id];
  localStorage.setItem('plannedIncidents', JSON.stringify(plannedIncidents));
  saveState(); // rendert die Einsätze-Seite automatisch
  renderPlannedList();
  alert('Geplanter Einsatz wurde zu den Einsätzen hinzugefügt (Entwurf).');
}

// Save
function saveState(){
  localStorage.setItem(STORAGE_KEYS.VEHICLES, JSON.stringify(vehicles));
  localStorage.setItem(STORAGE_KEYS.INCIDENTS, JSON.stringify(incidents));
  localStorage.setItem(STORAGE_KEYS.ACTIVE, activeId||'');
  localStorage.setItem(STORAGE_KEYS.VOR, voralarmActive?'true':'false');
  localStorage.setItem(STORAGE_KEYS.NOTICE, noticeText||'');
  localStorage.setItem('lastUpdate', Date.now().toString());
  renderAllPages();
}

function saveMembersState(){
  localStorage.setItem('members', JSON.stringify(members));
  renderOrganisationPage();
}

function renderOrganisation(){
  const list = document.getElementById('memberList');
  if(!list) return;
  list.innerHTML = '';

  Object.values(members).forEach(m => {
    // Liste der zugewiesenen Fahrzeuge
    const assignedVehicles = (m.vehicles || []).map(id => vehicles[id]?.name).filter(Boolean).join(', ') || '–';
    
    list.innerHTML += `<div class="list-item">
      <div>
        <b>${escapeHtml(m.name)}</b> — Fahrzeuge: ${escapeHtml(assignedVehicles)}
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn small" onclick="editMember('${m.id}')">Bearbeiten</button>
        <button class="btn small ghost" onclick="deleteMember('${m.id}')">Löschen</button>
      </div>
    </div>`;
  });
}

// Mitglieder-State
let members = JSON.parse(localStorage.getItem('members') || '{}');

// Speichern + Rendern
function saveMembersState() {
  localStorage.setItem('members', JSON.stringify(members));
  renderOrganisationPage();
}

// Escape-Funktion
function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

// Mitgliederliste rendern
function renderOrganisationPage() {
  const ml = document.getElementById('memberList');
  const filterSelect = document.getElementById('memberFilter');
  if (!ml || !filterSelect) return;

  const filter = filterSelect.value; // aktueller Filter
  ml.innerHTML = '';

  Object.values(members).forEach(m => {
    // Wenn gefiltert und Mitglied ist nicht zugewiesen, überspringen
    if (filter !== 'all' && !(m.vehicles || []).includes(filter)) return;

    const vehicleNames = (m.vehicles || []).map(id => vehicles[id]?.name).filter(Boolean).join(', ') || '–';
    ml.innerHTML += `<div class="list-item">
      <div><b>${escapeHtml(m.name)}</b> (${escapeHtml(m.role)}) — Fahrzeug: ${escapeHtml(vehicleNames)}</div>
      <div style="display:flex;gap:6px">
        <button class="btn small" onclick="editMember('${m.id}')">Bearbeiten</button>
        <button class="btn small ghost" onclick="deleteMember('${m.id}')">Löschen</button>
      </div>
    </div>`;
  });
}

// Mitglied hinzufügen
function addMember() {
  const name = prompt('Name des Mitglieds:');
  if(!name) return;
  const role = prompt('Rolle:') || '';
  const id = uid('mem');
  members[id] = {id, name, role, vehicles: []};
  selectMemberVehicles(id);
}

// Mitglied bearbeiten
function editMember(id) {
  const m = members[id]; if(!m) return;
  const name = prompt('Name:', m.name) || m.name;
  const role = prompt('Rolle:', m.role) || m.role;
  m.name = name;
  m.role = role;
  selectMemberVehicles(id);
}

// Mitglied löschen
function deleteMember(id) {
  if(!confirm('Mitglied löschen?')) return;
  delete members[id];
  saveMembersState();
}

// Fahrzeuge auswählen (Popup)
function selectMemberVehicles(id) {
  const m = members[id]; if(!m) return;

  // Overlay erstellen
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100vw';
  overlay.style.height = '100vh';
  overlay.style.background = 'rgba(0,0,0,0.5)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.zIndex = '9999';

  // Container
  const container = document.createElement('div');
  container.style.background = '#fff';
  container.style.padding = '20px';
  container.style.borderRadius = '12px';
  container.style.maxHeight = '80vh';
  container.style.overflowY = 'auto';
  container.style.minWidth = '300px';
  overlay.appendChild(container);

  // Titel
  const title = document.createElement('div');
  title.innerHTML = `<b>Fahrzeuge auswählen für ${escapeHtml(m.name)}</b>`;
  title.style.marginBottom = '12px';
  container.appendChild(title);

  // Fahrzeug-Checkboxen
  Object.values(vehicles).forEach(v => {
    const label = document.createElement('label');
    label.style.display = 'block';
    label.style.marginBottom = '6px';
    label.innerHTML = `<input type="checkbox" value="${v.id}" ${m.vehicles.includes(v.id) ? 'checked' : ''}> ${escapeHtml(v.name)} (${escapeHtml(v.call)})`;
    label.querySelector('input').addEventListener('change', e => {
      toggleMemberVehicle(id, v.id, e.target.checked);
    });
    container.appendChild(label);
  });

  // Speichern-Button
  const btn = document.createElement('button');
  btn.textContent = 'Speichern';
  btn.className = 'btn small';
  btn.style.marginTop = '12px';
  btn.onclick = () => {
    document.body.removeChild(overlay);
    saveMembersState();
  };
  container.appendChild(btn);

  document.body.appendChild(overlay);
}

// Checkbox ändern
function toggleMemberVehicle(memberId, vehicleId, checked){
  const m = members[memberId]; if(!m) return;
  if(checked){
    if(!m.vehicles.includes(vehicleId)) m.vehicles.push(vehicleId);
  } else {
    m.vehicles = m.vehicles.filter(v => v !== vehicleId);
  }
}

// Beim Laden aufrufen
renderOrganisationPage();

// Demo
function ensureDemoData(){
  if(Object.keys(vehicles).length===0){
    const a=uid('veh'); vehicles[a]={id:a,name:'LF 8/6',call:'Wache 1',status:1};
    const b=uid('veh'); vehicles[b]={id:b,name:'TLF 16/25',call:'Wache 2',status:2};
    const c=uid('veh'); vehicles[c]={id:c,name:'DLK',call:'Wache 3',status:6};
  }
  if(Object.keys(incidents).length===0){
    const i=uid('inc'); incidents[i]={id:i,keyword:'Übung',address:'Marktplatz 1, 12345 Stadt',desc:'Beispiel Einsatz',vehicles:[],status:'closed'};
  }
  saveState();
}

// Render
function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function renderAllPages(){renderDashboard(); renderVehiclesPage(); renderIncidentsPage(); renderFormVehicles(); renderMonitor(); renderDetailIfOpen();}

function showMonitorNotice(text) {
  const monitorPage = document.getElementById('page-monitor');
  if(!monitorPage || monitorPage.style.display === 'none') return; // Monitor nicht aktiv, nix anzeigen

  let popup = document.getElementById('monitorNoticePopup');
  if(!popup){
    popup = document.createElement('div');
    popup.id = 'monitorNoticePopup';
    popup.className = 'monitor-notice-popup';
    monitorPage.appendChild(popup);
  }

  popup.textContent = text;
  popup.classList.add('show');

  if(popup.timeoutId) clearTimeout(popup.timeoutId);
  popup.timeoutId = setTimeout(()=>{
    popup.classList.remove('show');
  }, 30000);
}

window.addEventListener('storage', ev => {
  if(ev.key === STORAGE_KEYS.NOTICE){
    noticeText = ev.newValue || '';
    renderAllPages();

    // Falls Monitor aktiv, Pop-up anzeigen
    const monitorVisible = document.getElementById('page-monitor').style.display !== 'none';
    if(monitorVisible && noticeText){
      showMonitorNotice(noticeText);
    }
  }
});

// Dashboard
function renderDashboard(){
  const box=document.getElementById('activeIncidentBox');
  if(!box) return;
  if(voralarmActive) box.innerHTML="<span style='color:#ff4444;font-weight:800'>VORALARM</span>";
  else if(activeId && incidents[activeId]) box.textContent=`${incidents[activeId].keyword} — ${incidents[activeId].address}`;
  else box.textContent='– Kein Einsatz aktiv –';
  const dv=document.getElementById('dashVehicles');
  if(dv){dv.innerHTML=''; Object.values(vehicles).forEach(v=>dv.innerHTML+=`<div style="margin-bottom:6px"><b>${escapeHtml(v.name)}</b> ${escapeHtml(v.call)} — Status ${v.status}</div>`);}
}

// Fahrzeuge
function renderVehiclesPage(){
  const vl = document.getElementById('vehicleList'); 
  if(!vl) return;
  vl.innerHTML = '';

  Object.values(vehicles).forEach(v=>{
    // Zähle Mitglieder, die diesem Fahrzeug zugewiesen sind
    const assignedMembersCount = Object.values(members)
      .filter(m => m.vehicles.includes(v.id))
      .length;

    vl.innerHTML+=`<div class="list-item">
      <div>
        <b>${escapeHtml(v.name)}</b> ${escapeHtml(v.call)} — 
        Besatzung: ${assignedMembersCount} Mann
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select class="status-select status-${v.status}" onchange="updateVehicleStatus('${v.id}', this.value)">
          ${[1,2,3,4,6].map(s=>`<option value="${s}" ${s==v.status?'selected':''}>${s}</option>`).join('')}
        </select>
        <button class="btn small ghost" onclick="editVehicle('${v.id}')">Bearbeiten</button>
        <button class="btn small ghost" onclick="deleteVehicle('${v.id}')">Löschen</button>
      </div>
    </div>`;
  });
}

function updateVehicleStatus(id,status){if(!vehicles[id]) return; vehicles[id]= {...vehicles[id], status: parseInt(status)}; saveState();}

// Einsätze
function renderIncidentsPage() {
  const il = document.getElementById('incidentList');
  if(!il) return;
  il.innerHTML = '';

  Object.values(incidents)
    .sort((a,b) => b.id.localeCompare(a.id))
    .forEach(i => {
      // Status-abhängiger Button für „Beenden“
      const endBtn = i.status === 'closed'
        ? `<button class="btn small ghost" disabled>Beendet</button>`
        : `<button class="btn small ghost" onclick="endIncidentList('${i.id}')">Beenden</button>`;

      il.innerHTML += `<div class="list-item">
        <div><span class="small-dot ${i.status==='active'?'red blink':''}"></span><b>${escapeHtml(i.keyword)}</b> ${escapeHtml(i.address)}</div>
        <div style="display:flex;gap:6px">
          <button class="btn small" onclick="showIncidentDetail('${i.id}')">Anzeigen</button>
          <button class="btn small" onclick="alarmFromList('${i.id}')">Alarmieren</button>
          ${endBtn}
          <button class="btn small ghost" onclick="deleteIncident('${i.id}')">Löschen</button>
        </div>
      </div>`;
    });
}

// Form vehicles
function renderFormVehicles(){
  const fv = document.getElementById('formVehicles');
  if(!fv) return;
  fv.innerHTML = '';
  Object.values(vehicles).forEach(v=>{
    const checked = selectedVehicles.includes(v.id) ? 'checked' : '';
    fv.innerHTML += `<div>
      <label>
        <input type="checkbox" value="${v.id}" ${checked} onchange="toggleFormVehicle('${v.id}', this.checked)">
        <b>${escapeHtml(v.name)}</b> (${escapeHtml(v.call)})
      </label>
    </div>`;
  });
}

// --- NEU: Auswahl verwalten ---
function toggleFormVehicle(id, isChecked){
  if(isChecked){
    if(!selectedVehicles.includes(id)) selectedVehicles.push(id);
  } else {
    selectedVehicles = selectedVehicles.filter(x => x !== id);
  }
}

// Monitor
function renderMonitor() {
  const mib = document.getElementById('monitorIncident');
  if(!mib) return;
  if(voralarmActive){
    mib.innerHTML = `<div class="voralarm">VORALARM</div>`;
  } else if(activeId && incidents[activeId]){
    const i = incidents[activeId];
    mib.innerHTML = `<div class="big"><span class="dot red blink"></span> ${escapeHtml(i.keyword)}</div>
                     <div class="monitor-sub">${escapeHtml(i.desc||'')}</div>	
                     <div class="monitor-sub">${escapeHtml(i.address||'')}</div>
                     <iframe class="map" src="https://www.google.com/maps?q=${encodeURIComponent(i.address||'')}&output=embed"></iframe>`;
    const noticeCard = document.getElementById('monitorNoticeCard'); if(noticeCard) noticeCard.style.display = 'none';
  } else {
    mib.innerHTML = `<div class="monitor-sub">– Kein Einsatz aktiv –</div>`;
    const noticeCard = document.getElementById('monitorNoticeCard'); if(noticeCard) noticeCard.style.display = '';
  }
  const mv = document.getElementById('monitorVehicles');
  if(mv){
    mv.innerHTML = '';
    Object.values(vehicles).forEach(v => {
      const isActive = activeId && incidents[activeId] && incidents[activeId].vehicles.includes(v.id);
      mv.innerHTML += `<div class="${isActive ? 'blink' : ''}"><b>${escapeHtml(v.name)}</b> (${escapeHtml(v.call)}) — 
                 <span class="status-select status-${v.status}">Status ${v.status}</span></div>`;
    });
  }
const mn = document.getElementById('monitorNotice');
if(mn){
  if(!activeId && !voralarmActive){
    // Nur abgeschlossene Einsätze (status === 'closed')
    const lastIncidents = Object.values(incidents)
      .filter(i => i.status === 'closed')       // <-- nur abgeschlossene
      .sort((a,b)=>b.id.localeCompare(a.id))
      .slice(0,5);
    
    mn.innerHTML = lastIncidents.map(i =>
      `<div style="font-size:28px"><b>${escapeHtml(i.keyword)}</b> — ${escapeHtml(i.address)}</div>`
    ).join('');
  } else {
    mn.innerHTML = '';
  }
}
  const audioBtn = document.getElementById('audioBtn');
  const audioContainer = document.getElementById('audioBtnContainer');
  if(audioEnabled || localStorage.getItem(STORAGE_KEYS.AUDIO_ACT) === 'true'){ audioEnabled = true; if(audioContainer) audioContainer.style.display = 'none'; } else { if(audioContainer) audioContainer.style.display = ''; }
}

// Detail
function renderDetailIfOpen(){
  if(!detailId) return; const i=incidents[detailId]; if(!i) return;
  document.getElementById('detailKeyword').innerHTML=`<b>Stichwort:</b> ${escapeHtml(i.keyword||'')}`;
  document.getElementById('detailDesc').innerHTML=`<b>Beschreibung:</b> ${escapeHtml(i.desc||'')}`;
  document.getElementById('detailAddress').innerHTML=`<b>Adresse:</b> ${escapeHtml(i.address||'')}`;
  document.getElementById('detailStatus').innerHTML=`<b>Status:</b> ${escapeHtml(i.status||'')}`;
  document.getElementById('detailMap').src=`https://www.google.com/maps?q=${encodeURIComponent(i.address||'')}&output=embed`;
}

// -------------------- CRUD & Actions --------------------
function openIncidentForm(){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none'); 
  document.getElementById('page-create').style.display='';

  document.getElementById('formKeyword').value=''; 
  document.getElementById('formAddress').value=''; 
  document.getElementById('formDesc').value='';

  selectedVehicles = []; // reset der Fahrzeug-Auswahl
  renderFormVehicles();  // Checkboxen direkt rendern
}

function saveIncident(status){
  const keyword=document.getElementById('formKeyword').value.trim();
  if(!keyword){ alert('Bitte Stichwort eingeben.'); return; }
  const address=document.getElementById('formAddress').value.trim();
  const desc=document.getElementById('formDesc').value.trim();
  const selected = [...selectedVehicles];
  const id=uid('inc'); incidents[id]={id,keyword,address,desc,vehicles:selected,status:status==='active'?'active':'draft'};
  if(status==='active'){ activeId=id; voralarmActive=false; playGong(document.getElementById('gong').value||'gong1',()=>speakAlarm(incidents[id])); }
  saveState(); showIncidentDetail(id); alert('Einsatz gespeichert.');
}

function showIncidentDetail(id){ detailId=id; document.querySelectorAll('.page').forEach(p=>p.style.display='none'); document.getElementById('page-incident-detail').style.display=''; renderAllPages(); }

function alarmFromList(id){ activeId=id; incidents[id].status='active'; voralarmActive=false; saveState(); playGong(document.getElementById('gong').value||'gong1',()=>speakAlarm(incidents[id])); }

function endIncident(){ if(detailId && incidents[detailId]){ incidents[detailId].status='closed'; if(activeId===detailId) activeId=null; saveState(); alert('Einsatz beendet.'); } }
function endIncidentList(id){ if(!incidents[id]) return; incidents[id].status='closed'; if(activeId===id) activeId=null; saveState(); }
function deleteIncident(id){ if(!confirm('Einsatz löschen?')) return; delete incidents[id]; if(activeId===id) activeId=null; if(detailId===id) detailId=null; saveState(); }

// Fahrzeuge
function addVehicle(){ const name=prompt('Fahrzeugname (z. B. LF 8/6)'); if(!name) return; const call=prompt('Funkrufname (z. B. Eltville 5/42)')||''; const id=uid('veh'); vehicles[id]={id,name,call,status:1}; saveState();}
function editVehicle(id){const v=vehicles[id]; if(!v)return; const name=prompt('Name',v.name)||v.name; const call=prompt('Funkruf',v.call)||v.call; v.name=name; v.call=call; saveState();}
function deleteVehicle(id){if(!confirm('Fahrzeug löschen?')) return; delete vehicles[id]; Object.values(incidents).forEach(i=>{if(i.vehicles)i.vehicles=i.vehicles.filter(x=>x!==id);}); saveState();}

// Voralarm, Nachalarm, speak/gong
function triggerVoralarm(){ voralarmActive=true; activeId=null; saveState(); playGong('gong3', ()=>speakText('Voralarm! Voralarm! Fahrzeuge besetzen!')); }
function nachalarmieren(){ if(detailId && incidents[detailId]) playGong(document.getElementById('gong').value||'gong1',()=>speakAlarm(incidents[detailId])); }

function playGong(key,onEnd){ if(!audioEnabled){console.warn('Audio nicht aktiviert'); return;} const audio=document.getElementById('gongAudio'); audio.src=gongs[key]||gongs['gong1']; audio.onended=()=>{if(onEnd) onEnd();}; audio.play().catch(e=>console.warn('Gong play failed',e)); }
function speakAlarm(i){
  if(!audioEnabled) return;
  const names = (i.vehicles||[])
    .map(id => vehicles[id]?.name)
    .filter(Boolean) // entfernt alle undefined
    .join(', ') || 'keine Fahrzeuge';
  
  const txt = ` ${i.keyword}. ${i.desc||''}. ${i.address||''}. Es rückt aus: ${names}.`;
  
  const u = new SpeechSynthesisUtterance(txt);
  u.lang = 'de-DE';
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function speakText(t){ if(!audioEnabled) return; const u=new SpeechSynthesisUtterance(t); u.lang='de-DE'; speechSynthesis.cancel(); speechSynthesis.speak(u);}
function monitorEnableAudio(){ if(!confirm('Audio aktivieren (Gong & Sprachausgabe)?')) return; audioEnabled=true; localStorage.setItem(STORAGE_KEYS.AUDIO_ACT,'true'); document.getElementById('audioBtnContainer').style.display='none'; alert('Audio aktiviert.'); }
function testGong(){ playGong(document.getElementById('gong').value||'gong1'); }
function sendNotice() {
  noticeText = document.getElementById('noticeText').value || '';
  saveState();
  speakText(noticeText);
  showMonitorNotice(noticeText); // <-- Pop-up im Monitor anzeigen
  alert('Mitteilung gesendet.');
}

// Navigation
document.querySelectorAll('.nav a').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  const page=a.dataset.page; const el=document.getElementById('page-'+page); if(el) el.style.display='';
  document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active')); a.classList.add('active');
  if(page==='monitor'){
    document.getElementById('sidebar').style.display='none';
    document.body.classList.add('monitor-active');
  }else{
    document.getElementById('sidebar').style.display='flex';
    document.body.classList.remove('monitor-active');
  }
}));

// Escape -> Dashboard
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const monitorVisible = document.getElementById('page-monitor').style.display !== 'none';
    if(monitorVisible){
      document.getElementById('page-monitor').style.display='none';
      document.getElementById('page-dashboard').style.display='';
      document.getElementById('sidebar').style.display='flex';
      document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active'));
      document.querySelector('[data-page="dashboard"]').classList.add('active');
      renderAllPages();
    }
  }
});

// Storage & polling
window.addEventListener('storage',ev=>{
  if(ev.key===null)return;
  vehicles=JSON.parse(localStorage.getItem(STORAGE_KEYS.VEHICLES)||'{}');
  incidents=JSON.parse(localStorage.getItem(STORAGE_KEYS.INCIDENTS)||'{}');
  activeId=localStorage.getItem(STORAGE_KEYS.ACTIVE)||null;
  voralarmActive=localStorage.getItem(STORAGE_KEYS.VOR)==='true';
  noticeText=localStorage.getItem(STORAGE_KEYS.NOTICE)||'';
  audioEnabled=localStorage.getItem(STORAGE_KEYS.AUDIO_ACT)==='true';
  renderAllPages();
});
setInterval(()=>{
  const storedVehicles=localStorage.getItem(STORAGE_KEYS.VEHICLES)||'{}';
  const storedIncidents=localStorage.getItem(STORAGE_KEYS.INCIDENTS)||'{}';
  const storedActive=localStorage.getItem(STORAGE_KEYS.ACTIVE)||null;
  const storedVor=localStorage.getItem(STORAGE_KEYS.VOR)==='true';
  const storedNotice=localStorage.getItem(STORAGE_KEYS.NOTICE)||'';
  const storedAudio=localStorage.getItem(STORAGE_KEYS.AUDIO_ACT)==='true';
  if(storedVehicles!==JSON.stringify(vehicles) || storedIncidents!==JSON.stringify(incidents) || storedActive!==(activeId||'') || storedVor!==voralarmActive || storedNotice!==noticeText || storedAudio!==audioEnabled){
    vehicles=JSON.parse(storedVehicles); incidents=JSON.parse(storedIncidents); activeId=storedActive||null; voralarmActive=storedVor; noticeText=storedNotice; audioEnabled=storedAudio; renderAllPages();
  }
},2000);

// Clock & Weather
function tick(){ const el=document.getElementById('clock'); if(el) el.textContent=new Date().toLocaleTimeString(); }
setInterval(tick,1000); tick();
async function fetchWeather(){ 
  try{ 
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.03&longitude=8.12&current_weather=true"); 
    const j=await r.json(); 
    const w=j.current_weather; 
    const text=w?`${Math.round(w.temperature)}°C – Wind ${Math.round(w.windspeed)} km/h`:'–'; 
    const wb=document.getElementById('weatherBox'); if(wb) wb.textContent=text; 
  }catch(e){console.warn('weather fetch failed',e);} 
} 
fetchWeather(); setInterval(fetchWeather,600000);

// Init
ensureDemoData(); renderAllPages();
</script>
</body>
</html>